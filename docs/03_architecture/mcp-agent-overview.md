# スクレイパーエージェント(MCP) 設計概要

このドキュメントは、実績データ自動収集スクレイパーエージェント（MCP）の要件、技術選定、およびアーキテクチャの概要をまとめたものです。

---

## 1. 要件定義書：実績データ自動収集スクレイパー - v5.0

### 1.1. 概要

本システムは、**各ASP専用のスクレイパー**により自動的にブラウザを操作して各種ASPから実績データを収集する**スクレイパーエージェント**である。

安定したデータ取得と、AI（Gemini）による自動修復機能を組み合わせ、高い運用効率を実現する。

### 1.2. 機能要件

#### 1.2.1. スクレイパー管理
- **ASP専用スクレイパー**: 各ASPに対して専用のPythonスクレイパーを実装
- **共通基盤クラス**: `BaseScraper`を継承して標準化された実装

#### 1.2.2. スクレイパーによる自動実行
- **ブラウザ操作**: Playwrightによる自動ログイン、ページ遷移、データ抽出
- **データ抽出と保存**: レポートページからデータを抽出し、Supabaseに保存

#### 1.2.3. 自動修復機能（Healer）
- **ScraperHealer**: AI（Gemini）を使用してエラー発生時にセレクタを自動修正
- **継続的改善**: エラーパターンを学習して修復精度を向上

#### 1.2.4. 定期実行
- Cloud Schedulerを利用し、指定したスケジュール（例：毎日午前7時）で全スクレイパーを自動実行

### 1.3. 非機能要件

- **安定性**: 専用スクレイパーによる予測可能な動作
- **保守性**: AI自動修復により、軽微なサイト変更には自動対応
- **信頼性と監視**: 処理の成功・失敗を詳細にログとして記録
- **セキュリティ**: 認証情報は`asp_credentials`テーブルで管理

---

## 2. 技術選定

### 2.1. 開発言語
- **Python**: Web自動化に最も成熟したエコシステム

### 2.2. 主要ライブラリ・サービス
- **ブラウザ自動操作**: **Playwright**
- **AI/LLM**: **Google Vertex AI (Gemini)** - スクレイパー自動修復用
- **データベース**: **Supabase (PostgreSQL)**

### 2.3. インフラストラクチャ
- **実行環境**: **Google Cloud Run**
- **スケジューラ**: **Google Cloud Scheduler**
- **コンテナ技術**: **Docker**

---

## 3. アーキテクチャ設計

### 3.1. ディレクトリ構成

```
apps/mcp-agent/
├── scrapers/           # ASP専用スクレイパー
│   ├── a8net/
│   │   └── scraper.py
│   ├── moshimo/
│   │   └── scraper.py
│   └── ...
├── core/               # 共通モジュール
│   ├── base_scraper.py # 基底クラス
│   ├── database.py     # DB操作
│   ├── browser.py      # ブラウザ制御
│   └── scraper_healer.py # 自動修復
├── runners/            # 実行スクリプト
│   ├── run_all_scrapers.py
│   ├── run_scraper.py
│   └── scheduled_runner.py
└── main.py
```

### 3.2. 処理フロー

1. **[GCP]** Cloud Schedulerが定刻にCloud Runを起動
2. **[スクレイパー]** 対象ASPのスクレイパーを起動
3. **[スクレイパー]** Supabaseから認証情報を取得
4. **[スクレイパー]** Playwrightでログイン・データ取得
5. **[スクレイパー]** 取得データをSupabaseに保存
6. **[Healer]** エラー発生時、AIがセレクタを自動修正

### 3.3. データフロー

```
asp_credentials  →  スクレイパー  →  daily_actuals / actuals
(認証情報)           (実行)           (保存)
```

---

## 4. 履歴

- 2025-12-03: プロンプト方式からスクレイパー方式に移行
- 2025-11-07: 初版作成（AIエージェント方式）
