# AIエージェント(MCP) 設計概要

このドキュメントは、実績データ自動収集AIエージェント（MCP）の要件、技術選定、およびアーキテクチャの概要をまとめたものです。

---

## 1. 要件定義書：実績データ自動収集AIエージェント (MCP) - v4.0

### 1.1. 概要 🤖
本システムは、**自然言語で記述されたシナリオ（手順書）**に基づき、自律的にブラウザを操作して各種ASPから実績データを収集する**AIエージェント**である。

非エンジニアでもシナリオ（プロンプト）を修正するだけで、ASP側の仕様変更に柔軟に対応できる、高いメンテナンス性を持つことを目的とする。

### 1.2. 機能要件 ⚙️

#### 1.2.1. シナリオ管理機能
-   **シナリオの登録・更新**: ユーザーは、本リポジトリの `apps/dashboard` を通じて、ASPごとに自然言語の操作シナリオを登録・更新できる。
-   **シナリオの形式**: シナリオは、「〇〇にアクセスして」「〇〇というボタンをクリックして」といった、人間が理解できる手順のリストとする。

#### 1.2.2. AIエージェントによる自動実行
-   **シナリオの解釈と実行**: AIエージェントは、指定されたASPのシナリオをデータベースから読み込み、その指示を一つずつ解釈しながらPlaywrightによるブラウザ操作に変換し、実行する。
-   **データ抽出と保存**: シナリオの最終段階として、指定された数値をWebページ上から抽出し、Supabaseの`daily_actuals`テーブルにデータを保存する。

#### 1.2.3. 定期実行
-   Cloud Schedulerを利用し、指定したスケジュール（例：毎日午前7時）で、全ASPのデータ取得シナリオを自動的に実行する。

### 1.3. 非機能要件 🛡️

-   **柔軟性・保守性**: ASPのWebサイトの仕様が変更された場合でも、原則として**コードの変更を必要とせず、自然言語シナリオの修正のみで対応可能**であること。
-   **信頼性と監視**: 処理の成功・失敗、および各ステップの実行状況を詳細にログとして記録する。エラー発生時には管理者に通知する。
-   **セキュリティ**: ASPのIDやパスワードといった認証情報は、データベースに保存せず、Google Secret Managerで厳重に管理する。

---

## 2. 技術選定：実績データ自動収集AIエージェント (MCP)

### 2.1. 開発言語
-   **Python**: Web自動化、AI/LLMとの連携、クラウドサービスとの親和性の全てにおいて、最もエコシステムが成熟しており、本プロジェクトに最適であるため。

### 2.2. 主要ライブラリ・サービス
-   **ブラウザ自動操作**: **Playwright**
    -   理由: モダンなAPIと、不安定さを解消する自動待機機能が非常に優秀なため。AIエージェントが実行するブラウザ操作の基盤として利用する。
-   **AI/LLM**: **Google Vertex AI (Gemini)**
    -   理由: 自然言語の解釈、WebページのHTML構造の理解、そして「次に実行すべきコマンド」を推論する能力に優れているため。本システムの「頭脳」として機能する。
-   **データベース**: **Supabase (PostgreSQL)**
    -   理由: `apps/dashboard` と共有のデータストアとして利用。操作シナリオ（プロンプト）の保存と、取得した実績データの格納場所となる。

### 2.3. インフラストラクチャ
-   **実行環境**: **Google Cloud Run**
    -   理由: コンテナベースのサーバーレス環境であり、処理の実行時のみリソースを使用するためコスト効率が高い。
-   **スケジューラ**: **Google Cloud Scheduler**
    -   理由: Cloud Runを定期的にトリガーするための標準的で信頼性の高いサービス。
-   **認証情報管理**: **Google Secret Manager**
    -   理由: パスワードなどの機密情報を安全に管理するためのベストプラクティス。
-   **コンテナ技術**: **Docker**
    -   理由: Python環境とライブラリをパッケージ化し、Cloud Runで確実に動作させるため。

---

## 3. アーキテクチャ設計書：実績データ自動収集AIエージェント (MCP)

### 3.1. 全体構成
本システムは、モノレポ内の `apps/mcp-agent` に配置されるPythonアプリケーションである。
`apps/dashboard` (Next.js) とは、Supabaseデータベースを介して疎に連携する。

**処理フロー:**
1.  **[Dashboard]** ユーザーがブラウザで自然言語の操作シナリオを編集し、Supabaseの`asps`テーブルに保存する。
2.  **[GCP]** Cloud Schedulerが定刻になると、Cloud Run上で動作するAIエージェント (`apps/mcp-agent`) を起動する。
3.  **[AIエージェント]** Supabaseから対象ASPのシナリオを読み込む。
4.  **[AIエージェント]** Playwrightでブラウザを起動し、シナリオの最初のステップを開始する。
5.  **[AIエージェNT]** 現在のWebページの状態と次の指示をGeminiに送り、実行すべきPlaywrightコマンドを受け取る。
6.  **[AIエージェント]** 受け取ったコマンドを実行する。
7.  **[AIエージェント]** シナリオが完了するまで5〜6を繰り返す。
8.  **[AIエージェント]** 最終的に抽出したデータをSupabaseの`daily_actuals`テーブルに書き込む。

### 3.2. コードとプロンプトの役割分担

本システムの核心は、**汎用的な「コード（厨房）」**と、**具体的な「プロンプト（レシピ）」**を明確に分離することにある。

#### 3.2.1. コードの役割（一度だけ実装する土台）
`apps/mcp-agent` に配置されるPythonコードは、AIエージェントの**不変的な「能力」と「思考回路」**を担当する。
-   **ブラウザ制御**: Playwrightの起動・終了。
-   **外部連携**: Secret ManagerやSupabaseとの接続機能。
-   **AIエージェントループ**:
    1.  シナリオを1行読む。
    2.  現在のページ情報を取得する。
    3.  AI (Gemini) に「この状況とこの指示なら、次に何をすべきか？」と問い合わせる。
    4.  AIの答え（実行すべきコマンド）を受け取って実行する。
-   **エラーハンドリング**: 共通のエラー処理とロギング。

#### 3.2.2. プロンプトの役割（ASPごとに記述・修正するもの）
データベースに保存する自然言語のシナリオは、AIエージェントに渡す**具体的な「指示書」**の役割を担う。
-   **操作手順**: 「ログインページに移動して」「レポートボタンを押して」など。
-   **対象の指定**: 「'成果'というテキストを含むテーブル」など、人間が見てわかる形での要素指定。
-   **抽出データの指定**: 「'確定報酬'の列の数値を抜き出して」など。
-   **認証情報の利用**: プロンプト内では `{SECRET:A8_PASSWORD}` のような特別なプレースホルダーを記述する。AIエージェントは実行時にこのプレースホルダーを検知し、Google Secret Managerから実際の値を取得して利用する。

この分離により、ASPのサイトが変更されても、開発者は**コードを触ることなく、ユーザーがプロンプトを修正するだけで対応できる**ようになる。