# Database Migrations

このディレクトリには、データベーススキーマの変更を管理するマイグレーションファイルが含まれています。

## マイグレーションの実行方法

### Supabase SQLエディタを使用する場合

1. Supabaseダッシュボードにログイン
2. プロジェクトを選択
3. 左メニューから「SQL Editor」を開く
4. マイグレーションファイルの内容をコピー＆ペースト
5. 「Run」ボタンをクリック

### Supabase CLIを使用する場合

```bash
# マイグレーションファイルを配置
supabase migration new add_media_id_to_asps

# ファイルに内容をコピーして保存

# ローカルで実行
supabase db reset

# 本番環境にプッシュ
supabase db push
```

## マイグレーション一覧

### `20251014_add_media_id_to_asps.sql`

**目的**: ASPテーブルにメディアIDを追加し、制約を改善

**変更内容**:
- `media_id`カラムを追加（`media`テーブルへの外部キー）
- `updated_at`カラムを追加
- `category`カラムを削除
- UNIQUE制約を`(name, media_id)`に変更
- 自動更新トリガーを追加

**実行前の確認事項**:
1. 既存のASPレコードがある場合、`media_id`を手動で設定する必要がある
2. `login_url`と`prompt`が空のレコードがないか確認

**実行後の作業**:
1. 既存データの`media_id`を設定
2. コメントアウトされたNOT NULL制約とUNIQUE制約を有効化

## 注意事項

- マイグレーションは**本番環境で実行する前に、必ずステージング環境でテストしてください**
- 各マイグレーションファイルには、ロールバック用のSQLも準備することを推奨します
- 大きなテーブルの変更は、ダウンタイムを考慮してください
