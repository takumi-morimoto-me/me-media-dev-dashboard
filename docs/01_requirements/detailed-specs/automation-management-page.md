# 自動化管理ページ 詳細要件定義

本要件定義は、メディアDevダッシュボードのUI上から、独立した「実績データ自動収集AIエージェント（MCP）」を管理・操作するための専用ページに関するものである。

---
## Phase 1：監視と手動実行（MVP）
**ゴール：AIエージェントの実行状況を可視化し、ユーザーが必要な時に手動で処理を動かせるようにする。**

### 1. UIの基本構成
-   サイドバーに「自動化管理」という新しいナビゲーション項目を追加し、本ページへ遷移できるようにする。
-   ページは、登録されているASPの一覧がテーブル形式で表示されるダッシュボード形式とする。

### 2. ASPステータス一覧
-   各ASPについて、以下の情報を表示する。
    -   **ASP名**: `asps`テーブルに登録されている名前
    -   **所属メディア名**: このASPが紐づいているメディア名
    -   **最終実行日時**: このASPの処理が最後に実行された日時
    -   **最終実行ステータス**: 成功 ✅ / 失敗 ❌ / 実行中 🏃... のようなアイコンで分かりやすく表示

### 3. 手動実行機能
-   **個別実行**: 各ASPの行に「今すぐ実行」ボタンを設置。クリックすると、そのASPのデータ取得処理が即座に開始される。
-   **一括実行**:
    -   **日次データの一括再取得**: 「全ASPの昨日分を再取得」ボタンを設置。全ASPのデータ取得を一度にトリガーする。
    -   **期間指定での再取得**: ユーザーがカレンダーで期間（例: `10月1日〜10月31日`）を指定し、「指定期間を再取得」ボタンを押すと、その期間中の日次データをすべて再取得する処理を開始する。（※ご要望の「月次データの一括再取得」は、この機能で実現します）

### 4. 実行ログの確認（簡易版）
-   ステータス一覧の各行から、その実行ログを確認できるモーダルを開けるようにする。
-   成功時は「正常に完了しました」、失敗時は**エラーメッセージ**が表示される。

---
## Phase 2：ASP設定とシナリオ（プロンプト）の管理
**ゴール：非エンジニアでも、AIエージェントの振る舞い（操作手順）をUI上から安全に修正できるようにする。**

### 1. ASPのCRUD機能
新しいASPをシステムに登録・編集・削除するためのUIを実装する。

**登録・編集項目:**
-   **ASP名**: 識別しやすい名前（例: 「A8.net」「もしもアフィリエイト」）
-   **ログインURL**: ASPのログインページURL
-   **所属メディア**: このASPがどのメディアに紐づくか（セレクトボックスで選択）
-   **操作プロンプト**: AIエージェントへの自然言語の操作指示（詳細は下記）

**データ保存先:**
-   Supabaseの`asps`テーブル
-   同じメディア内で同名ASPの登録は不可（UNIQUE制約）

### 2. プロンプト（シナリオ）エディタ
ASPの登録・編集画面内に、自然言語で記述された操作シナリオを編集するための、**広めのテキスト入力エリア**を設ける。

**プロンプトの記述例:**
```
1. {login_url}にアクセスする
2. ユーザー名フィールドに{SECRET:A8_USERNAME}を入力
3. パスワードフィールドに{SECRET:A8_PASSWORD}を入力
4. 「ログイン」ボタンをクリック
5. 「レポート」メニューをクリック
6. 「成果報酬」のテーブルから昨日の確定報酬額を取得
```

**機能:**
-   マークダウン対応のテキストエリア
-   シークレット情報のプレースホルダー記述サポート（例: `{SECRET:KEY_NAME}`）
-   プロンプトは`asps`テーブルの`prompt`カラムに保存

### 3. プロンプトのバージョン管理（将来実装）
-   プロンプトが変更されるたびに、その履歴を保存する機能を実装する。
-   これにより、「プロンプトを修正したら動かなくなったので、前のバージョンに戻したい」といった操作が可能になる。
-   ※Phase 2では実装せず、Phase 3以降で検討

---
## Phase 3：高度な分析と運用機能
**ゴール：エラーの原因を詳細に分析し、システムの運用をより効率化するための機能を提供する。**

### 1. 詳細なエラー分析UI
-   ご要望の「**プロンプトからの実行処理で止まってしまった場所把握**」を実現する機能。
-   実行ログ画面を強化し、失敗したシナリオのどのステップでエラーが発生したかをハイライト表示する。
-   エラー発生時のスクリーンショットや、AIへの最終的な問い合わせ内容なども表示し、原因究明を容易にする。

### 2. スケジュール管理機能
-   各ASPの定期実行スケジュール（例: 毎日午前7時）を、UI上から**有効/無効**に切り替えられるトグルスイッチを設置する。

### 3. 実行パフォーマンス分析
-   各ASPの処理にかかる平均時間や、成功率・失敗率などをグラフで可視化する。
-   これにより、処理が不安定なASPや、時間がかかりすぎているASPを特定し、改善のアクションに繋げることができる。
