# 予実管理ページ 実装要件定義 (2025-10-07版)

## 実装済み機能（仕様外）

以下の機能は当初の要件定義には含まれていませんが、開発中に実装されました：

### 1. メディア管理機能
-   **メディア追加機能**: メディアリストの右上にある「+」ボタンから、新規メディアを作成できます。
    -   メディア名とスラッグを入力するダイアログが表示されます。
    -   作成後、自動的にメディアリストに追加されます。
-   **勘定項目自動作成**: メディア作成時に、データベーストリガーで「売上」「費用」の大項目が自動生成されます。

### 2. 全メディア集約表示
-   メディア選択で「全てのメディア」を選択すると、全メディアの予算・実績データを勘定項目名で集約して表示します。
-   RPC関数 `get_financial_summary` が `p_media_id = NULL` の場合に、全メディアを集約するロジックを実装しています。

### 3. UIレイアウト
-   **3カラムレイアウト**: Supabase風のUI構成
    -   左: グローバルサイドバー（ダッシュボード、テーブルへのナビゲーション）
    -   中央: メディアリスト（240px幅、全てのメディア + 各メディア）
    -   右: コンテンツエリア（財務テーブル表示）

### 4. TSV/CSVインポート機能（2025-10-08実装）
-   **TSV形式推奨**: カンマ入り数値に対応したタブ区切り形式
    -   予算・実績両方 / 予算のみ / 実績のみ の3パターン対応
    -   テンプレートダウンロード機能付き
-   **CSV形式対応**: レガシー対応として利用可能
    -   CSV使用時は警告表示（カンマ入り数値の注意喚起）
-   **部分更新モード**: 指定した親項目配下のみ更新、他の項目は保持
-   **勘定項目 + 予実データ同時登録**:
    - スプレッドシートから直接データを準備してアップロード可能
    - 親項目（売上・費用）が存在しない場合は自動作成

### 5. 勘定項目削除機能（2025-10-08実装）
-   **個別削除**: 各行のゴミ箱アイコンで1件ずつ削除
-   **複数選択削除**: チェックボックスで複数選択後、一括削除
-   **全選択**: ヘッダーのチェックボックスで全項目選択
-   親項目・子項目どちらも削除可能
-   削除前に確認ダイアログを表示

### 6. ロールアップ集計機能（2025-10-08実装）
-   **自動集計**: 子項目（広告収入、制作収入など）の合計が親項目（売上）に自動的に集計表示
-   **再帰的CTE実装**: PostgreSQLの再帰クエリで階層構造を辿って合計を計算
-   **RPC関数**: `get_financial_summary` に実装済み

### 7. フィルター機能
-   **Supabase風UI**: ポップオーバー形式のフィルターパネル
    -   会計年度選択（現在年度±5年）
    -   表示項目選択（予実比較 / 予算のみ / 実績のみ）
-   **アクティブフィルター表示**: 選択中のフィルターをタグ表示、個別解除可能

---

## Phase 1：基本表示機能（MVP）

**ゴール：月次の全体像を把握し、日次へのドリルダウンが可能なプロトタイプを構築する**

### 1. UIコンポーネントの実装
-   **ページレイアウト**: ヘッダー、サイドバーを含む基本的な画面構成を配置します。
-   **フィルターエリア**: 画面上部に、全体に適用されるフィルターを設置します。
    -   **メディア選択**: 操作対象のメディアを選択するドロップダウン。
    -   **会計期選択**: 表示する会計期を選択するドロップダウン。（デフォルトは今期会計）
-   **テーブルコンポーネント**:
    -   `shadcn/ui`の`Table`をベースに、月次・日次表示の切り替えに対応できるテーブルを実装します。
    -   この時点では**データ表示のみ（読み取り専用）**とします。

### 2. データ表示と操作
-   **デフォルト表示（月次ビュー）**:
    -   ページを開くと、デフォルトで選択された会計期の**12ヶ月分のデータ**が列として表示されます。
    -   各月の列には `予算`, `実績`, `差異`, `達成率` が含まれます。
    -   行には、階層化された勘定項目（大項目・小項目）が表示されます。
-   **ドリルダウン機能（日次ビュー）**:
    -   テーブルの**月の列ヘッダー**（例: `4月`）をクリックすると、その月の日次ビューに切り替わります。
    -   日次ビューでは、テーブルの列が**1日〜31日**に変化し、各日の `予算` と `実績` が表示されます。
-   **バックエンド連携**:
    -   月次ビュー: 選択されたフィルター条件（メディア、会計期）に基づき、12ヶ月分の予実データを取得するSupabase関数（RPC）を呼び出します。
    -   日次ビュー: 選択された月とフィルター条件に基づき、1ヶ月分の日次予実データを取得するRPCを呼び出します。（※RPCは月次用と日次用で分けるか、パラメータで対応するかを別途検討）

---

## Phase 2：データ入力機能のコア実装

**ゴール：CSVと手入力の両方で、予算データを登録・更新できる状態にする**

ユーザーが予算データを登録するための主要な機能（CSVと直接編集）をこのフェーズで実装します。

### 1. データ操作機能
-   **✅ TSV/CSVインポート機能** (2025-10-08完了):
    -   TSV形式推奨（カンマ入り数値対応）
    -   予算・実績・両方の3パターン対応
    -   勘定項目 + 予実データ同時登録
    -   部分更新モード（指定親項目のみ更新）
-   **CSVエクスポート機能**: 表示されているデータをCSV/TSV形式でダウンロードできるようにします。（未実装）
-   **✅ 勘定項目削除機能** (2025-10-08完了):
    -   個別削除、複数選択削除、全選択対応
-   **予算の直接編集機能**（未実装）:
    -   `予算`列のセルをクリックすると、数値入力モードに切り替わるようにします。
    -   数値入力後、セルからフォーカスが外れるかEnterキーを押すと、変更内容がSupabaseのデータベースに**自動で保存**されるようにします。
    -   保存中・保存完了・失敗をユーザーにフィードバックする機能を実装します。

### 2. 表示切替スイッチ機能
-   **✅ 実装済み** (2025-10-08完了): フィルターパネル内で以下の3つの状態を切り替え可能
    -   `[ 予実比較 ]` (デフォルト)
    -   `[ 予算のみ ]`
    -   `[ 実績のみ ]`
-   テーブルの列が動的に表示・非表示されます。

---

## Phase 3：高度な機能とUI/UX向上

**ゴール：データ入力の効率を最大化し、洗練された使い心地を実現する**

コア機能が完成した上で、より高度なデータ入力支援機能や、UXをさらに洗練させるための改善を加えます。

### 1. 高度なデータ入力支援
-   **月次予算からの日次自動ブレークダウン**: 月次ビューで予算セルに数値を入力すると、その値を日数で割り、日次ビューの各セルに自動的に反映させる機能を実装します。

### 2. UI/UXの向上
-   **ヘッダーと列の固定 (Sticky)**: 縦横にスクロールしても、月や勘定項目のヘッダーが常に画面に表示され続けるようにします。
-   **ローディング表示**: 最初にデータを読み込む際に、テーブル全体にスケルトンスクリーンを表示し、ユーザーが待機中であることを明確に伝えます。
-   **空の状態の表示**: データが1件も存在しない場合に、「データがありません」といったメッセージを表示するUIを実装します。
