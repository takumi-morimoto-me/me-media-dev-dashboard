# ASPデータ取得機能要件定義

**最終更新**: 2025-11-04

---

## 1. 概要

本文書は、ASP（アフィリエイトサービスプロバイダ）からの実績データ自動取得機能の要件を定義する。

本機能は、複数のASPから日次・月次データを自動収集し、データベースに保存することで、ダッシュボードでの予実分析を可能にする。

---

## 2. 機能要件

### 2.1. 指定月データ取得機能

**要件ID**: ASP-REQ-001

**概要**: 任意の年月を指定して、その月の日次データと月次データを取得できること。

#### 2.1.1. 日次データ取得

**機能**:
- 指定した年月の全日次データを取得
- 例: `2025年1月` を指定 → 2025-01-01 〜 2025-01-31 のデータを取得

**入力パラメータ**:
- 年月（YYYY-MM形式）
- ASP ID（オプション：指定ASPのみ取得）
- メディア ID（オプション：指定メディアのみ取得）

**出力**:
- 日次実績データ（`daily_actuals` テーブルに保存）
- 取得件数、成功・失敗レポート

**データ仕様**:
```typescript
{
  date: string;          // 実際の日付（例: '2025-01-15'）
  amount: number;        // 金額
  media_id: string;      // メディアID
  account_item_id: string; // 勘定科目ID
  asp_id: string;        // ASP ID
}
```

#### 2.1.2. 月次データ取得

**機能**:
- 指定した年月の月次集計データを取得
- 月次データは**月末日付**で保存されること

**入力パラメータ**:
- 年月（YYYY-MM形式）
- ASP ID（オプション）
- メディア ID（オプション）

**出力**:
- 月次実績データ（`actuals` テーブルに保存）
- 取得件数、成功・失敗レポート

**データ仕様**:
```typescript
{
  date: string;          // 月末日付（例: '2025-01-31'）
  amount: number;        // 金額
  media_id: string;      // メディアID
  account_item_id: string; // 勘定科目ID
  asp_id: string;        // ASP ID
}
```

#### 2.1.3. 実行方法

**手動実行**:
```bash
# 日次データ取得
pnpm exec tsx src/scripts/[asp-name]-daily-scraper.ts --month 2025-01

# 月次データ取得
pnpm exec tsx src/scripts/[asp-name]-monthly-scraper.ts --month 2025-01
```

**UI経由**:
- ダッシュボードの「データ取得」画面から年月を指定して実行
- 複数ASPを一括選択して実行可能

---

### 2.2. 最新データ自動取得機能

**要件ID**: ASP-REQ-002

**概要**: 最新の日次・月次データを定期的に自動取得し、データベースを最新状態に保つこと。

#### 2.2.1. 日次データ自動取得

**実行タイミング**:
- 毎日午前9時に自動実行
- 前営業日のデータを取得

**取得対象**:
- 全ASPの前日データ
- 全メディアのデータ

**動作仕様**:
1. 実行時刻になると自動起動
2. 認証情報がある全ASPを順次処理
3. 各ASPから前日のデータを取得
4. `daily_actuals` テーブルに UPSERT（既存データは上書き）
5. 実行結果をログに記録
6. エラー発生時は通知（後述）

**スケジューリング方法**:
- GitHub Actions / cron job
- または、Vercel Cron Jobs
- または、Supabase Edge Functions + pg_cron

#### 2.2.2. 月次データ自動取得

**実行タイミング**:
- 毎月1日午前10時に自動実行
- 前月の月次データを取得

**取得対象**:
- 全ASPの前月データ
- 全メディアのデータ

**動作仕様**:
1. 実行時刻になると自動起動
2. 認証情報がある全ASPを順次処理
3. 各ASPから前月のデータを取得
4. `actuals` テーブルに UPSERT（**月末日付で保存**）
5. 実行結果をログに記録
6. エラー発生時は通知

#### 2.2.3. 再実行機能

**要件**:
- 自動取得が失敗した場合、手動で再実行できること
- UI上で「最新データ取得」ボタンを押すと即座に実行

**UI仕様**:
- ボタン名: 「最新データ取得」
- 配置: ダッシュボードヘッダー
- 実行中は進捗状態を表示
- 完了時に成功・失敗件数を通知

---

## 3. 非機能要件

### 3.1. パフォーマンス

**要件ID**: ASP-NFR-001

**要件**:
- 1ASPあたりの日次データ取得時間: 5分以内
- 1ASPあたりの月次データ取得時間: 3分以内
- 全ASP（30件）の並列実行時: 30分以内に完了

**制約**:
- ASP側のレート制限を遵守
- 同時接続数: 最大5件まで

### 3.2. 信頼性

**要件ID**: ASP-NFR-002

**要件**:
- データ取得成功率: 95%以上（月平均）
- リトライ機構: 失敗時は最大3回まで自動再試行
- タイムアウト設定: 1ページあたり30秒

**エラーハンドリング**:
1. ネットワークエラー → 3回リトライ
2. 認証エラー → 即座に失敗、通知送信
3. データ形式エラー → ログに記録、スキップ
4. タイムアウト → リトライ

### 3.3. データ整合性

**要件ID**: ASP-NFR-003

**必須ルール**:
- 月次データは**必ず月末日付**で保存
- 日次データと月次データを**絶対に合算しない**
- UNIQUE制約により重複データを防止
- UPSERTにより既存データを安全に更新

**検証方法**:
- テストスクリプトによる自動検証
- 月末日付チェック
- 重複データチェック

### 3.4. セキュリティ

**要件ID**: ASP-NFR-004

**認証情報管理**:
- ASP認証情報は環境変数 or Supabase Vault で管理
- リポジトリに平文で保存しない
- ログに認証情報を出力しない

**アクセス制御**:
- スクレイパー実行権限は管理者のみ
- 自動実行用のサービスアカウントを作成

---

## 4. ユースケース

### 4.1. 過去データの一括取得

**シナリオ**:
新しいASPを追加した際に、過去3ヶ月分のデータをまとめて取得したい。

**手順**:
1. ダッシュボードの「データ取得」画面を開く
2. ASPを選択（例: バリューコマース）
3. 取得期間を指定（例: 2024-10 〜 2025-01）
4. 「日次データ取得」ボタンをクリック
5. 進捗状態を確認
6. 完了後、取得件数を確認

**期待結果**:
- 2024年10月〜2025年1月の全日次データが取得される
- データは `daily_actuals` テーブルに保存される
- 既存データがある場合は上書きされる

### 4.2. 最新データの定期自動取得

**シナリオ**:
毎日自動的に前日のASP実績データを取得し、ダッシュボードを最新状態に保つ。

**手順**:
1. 毎日午前9時に自動実行（cron設定済み）
2. 全ASPから前日データを取得
3. データベースに保存
4. 実行結果をSlackに通知

**期待結果**:
- ダッシュボードを開くと常に前日までのデータが表示される
- データ取得失敗時は通知が届く
- 手動で再実行可能

### 4.3. 月次データの取得

**シナリオ**:
月初に前月の月次集計データを取得する。

**手順**:
1. 毎月1日午前10時に自動実行
2. 全ASPから前月の月次データを取得
3. 月末日付でデータベースに保存
4. 実行結果を通知

**期待結果**:
- 前月のデータが月末日付で保存される
- 例: 2025年1月1日実行 → 2024-12-31 でデータ保存

---

## 5. データ取得仕様詳細

### 5.1. 対応ASP一覧

**実装済み（24件）**:
- A8.net, もしもアフィリエイト, Link-AG, felmat, afb
- アクセストレード, Amazonアソシエイト, DMMアフィリエイト
- リンクシェア, バリューコマース, JANet, TGアフィリエイト
- レントラックス, Smart-C, i-mobile, Zucks Affiliate
- CASTALK, CircuitX, SmaAD, SKYFLAG
- アルテガアフィリエイト, Ratel AD, ドコモアフィリエイト, PRESCO

**未実装（6件）**:
- 優先度1: Slvr Bullet, DoccomoAffilliate
- 優先度2: App＋アフィリエイト, AFRo, Affilliate-B, aima

### 5.2. 取得データ項目

**日次データ**:
- 日付
- 発生報酬額
- 確定報酬額
- クリック数
- コンバージョン数

**月次データ**:
- 月（月末日付で保存）
- 発生報酬額合計
- 確定報酬額合計
- クリック数合計
- コンバージョン数合計

### 5.3. データマッピング

ASPによってデータ項目名が異なるため、統一した勘定科目にマッピングする。

| ASP表示名 | 勘定科目名 | account_item_id |
|-----------|-----------|-----------------|
| 発生報酬 | ASP売上（発生） | `uuid` |
| 確定報酬 | ASP売上（確定） | `uuid` |
| クリック数 | クリック数 | `uuid` |
| CV数 | コンバージョン数 | `uuid` |

---

## 6. エラー処理と通知

### 6.1. エラー分類

**レベル1: 致命的エラー**
- 認証失敗
- データベース接続エラー
→ 即座に実行停止、管理者に通知

**レベル2: 警告**
- 一部データの取得失敗
- タイムアウト
→ ログに記録、処理継続、完了後に通知

**レベル3: 情報**
- データなし（該当日にデータが存在しない）
→ ログに記録のみ

### 6.2. 通知方法

**Slack通知**:
```
【ASPデータ取得完了】
- 実行日時: 2025-01-15 09:00
- 対象ASP: 24件
- 成功: 22件
- 失敗: 2件（afb, Amazonアソシエイト）
- 取得件数: 456件

詳細: [ログを見る]
```

**メール通知**（エラー時のみ）:
- 件名: 【エラー】ASPデータ取得失敗
- 本文: エラー詳細とリトライ手順

---

## 7. テスト要件

### 7.1. 単体テスト

**対象**:
- 各ASPスクレイパーの個別テスト
- 日付計算ロジック（月末日付）
- データマッピング処理

**テスト項目**:
- ✅ 日次データが正しいテーブルに保存される
- ✅ 月次データが月末日付で保存される
- ✅ データの重複がない（UPSERT動作）
- ✅ 日次と月次が合算されていない

### 7.2. 結合テスト

**対象**:
- 複数ASPの並列実行
- エラー時のリトライ処理
- 通知機能

**テスト項目**:
- ✅ 5件同時実行が正常に動作する
- ✅ エラー時に3回リトライする
- ✅ 通知が正しく送信される

### 7.3. E2Eテスト

**シナリオ**:
1. 指定月のデータ取得（UI経由）
2. 最新データ自動取得（スケジューラー経由）
3. エラー発生時の再実行

---

## 8. 実装優先度

### フェーズ1: MVP（最小限の機能）

**目標**: 手動でデータ取得できる状態

- ✅ 指定月の日次データ取得（CLI）
- ✅ 指定月の月次データ取得（CLI）
- ✅ 主要ASP 5件の実装
- ✅ データ整合性チェック

### フェーズ2: 自動化

**目標**: 自動取得が動作する状態

- [ ] 日次データ自動取得（cron）
- [ ] 月次データ自動取得（cron）
- [ ] エラー通知機能
- [ ] 実行ログの保存

### フェーズ3: UI実装

**目標**: UIから操作できる状態

- [ ] データ取得画面の実装
- [ ] 進捗状態の表示
- [ ] 実行履歴の表示
- [ ] エラー詳細の表示

### フェーズ4: 拡張

**目標**: 全ASP対応

- [ ] 残り19件のASP実装
- [ ] 並列実行の最適化
- [ ] パフォーマンス改善

---

## 9. 関連ドキュメント

- [データ仕様書](./data-specification.md)
- [スクレイパー実装ガイド](../../04_development/scrapers/guide.md)
- [スクレイパーテストチェックリスト](../../04_development/scrapers/testing.md)
- [ASP実装状況](../../04_development/scrapers/status.md)

---

## 10. 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-11-04 | 初版作成 |

---

最終更新日: 2025-11-04
