# CSV インポート機能

ASP（アフィリエイトサービスプロバイダ）のデータを CSV ファイルから一括インポートする機能について説明します。

## 概要

CSV インポート機能を使用すると、複数の ASP のデータをまとめて登録・更新できます。この機能は Agent Management ページから利用できます。

## CSV ファイルの形式

### ヘッダー

CSVファイルの1行目は以下のヘッダーが必要です：

```csv
サービス名,ログインURL,カテゴリ,プロンプト,メディア名,ユーザー名,パスワード
```

### フィールド説明

| フィールド名 | 必須 | 説明 | 例 |
|------------|------|------|-----|
| サービス名 | ✓ | ASPのサービス名 | A8.net |
| ログインURL | ✓ | ASPのログインページURL | https://www.a8.net/ |
| カテゴリ | - | ASPのカテゴリ（オプション） | 総合型ASP |
| プロンプト | - | AI エージェント用の指示（オプション） | A8.netの成果レポートを取得 |
| メディア名 | - | 関連付けるメディア名（オプション） | メディアA |
| ユーザー名 | - | ログインユーザー名（オプション） | user@example.com |
| パスワード | - | ログインパスワード（オプション） | ******** |

### サンプル CSV

```csv
サービス名,ログインURL,カテゴリ,プロンプト,メディア名,ユーザー名,パスワード
A8.net,https://www.a8.net/,総合型ASP,A8.netの成果レポートを取得してデータベースに保存,メディアA,user@example.com,password123
afb,https://www.afi-b.com/,総合型ASP,afbの成果レポートを取得してデータベースに保存,メディアA,user@example.com,password456
```

### 注意事項

1. **文字コード**: UTF-8 で保存してください
2. **改行コード**: LF または CRLF を使用できます
3. **引用符**: フィールドにカンマや改行が含まれる場合は、ダブルクォート（`"`）で囲んでください
4. **コメント**: `#` で始まる行はコメントとして無視されます

### 引用符の例

```csv
サービス名,ログインURL,カテゴリ,プロンプト,メディア名,ユーザー名,パスワード
"A8.net","https://www.a8.net/","総合型ASP","A8.netにログインして、成果レポートを取得し、データベースに保存してください。","メディアA","user@example.com","password123"
```

## インポート手順

### 1. CSV ファイルの準備

上記の形式に従って CSV ファイルを作成します。

### 2. インポートダイアログを開く

1. Agent Management ページに移動
2. 画面右上の「Import CSV」ボタンをクリック
3. CSV Import ダイアログが開きます

### 3. ファイルのアップロード

以下のいずれかの方法でファイルをアップロードします：

**方法1: クリックして選択**
1. 「Click to upload」ボタンをクリック
2. ファイル選択ダイアログからCSVファイルを選択

**方法2: ドラッグ&ドロップ**
1. CSVファイルをダイアログの領域にドラッグ
2. ファイルをドロップ

### 4. インポート結果の確認

インポートが完了すると、結果が表示されます：

- **成功**: 正常にインポートされた件数
- **失敗**: インポートに失敗した件数
- **詳細**: 各レコードの処理状況

### 5. エラーの対処

インポートに失敗したレコードがある場合：

1. エラーメッセージを確認
2. CSV ファイルの該当行を修正
3. 再度インポートを実行

## CSV エクスポート機能

既存の ASP データを CSV ファイルとしてエクスポートすることもできます。

### エクスポート手順

1. Agent Management ページに移動
2. 「Export CSV」ボタンをクリック
3. CSVファイルがダウンロードされます

### 用途

- **バックアップ**: データのバックアップとして保存
- **編集**: CSV で一括編集してから再インポート
- **移行**: 他の環境へのデータ移行

## データの更新

既に登録されている ASP と同じサービス名の行をインポートすると、データが更新されます。

### 更新される項目

- ログインURL
- カテゴリ
- プロンプト
- メディア名（メディアが存在する場合）
- ユーザー名
- パスワード

### 更新の動作

```csv
# 既存のA8.netのデータを更新
サービス名,ログインURL,カテゴリ,プロンプト,メディア名,ユーザー名,パスワード
A8.net,https://www.a8.net/,新しいカテゴリ,更新されたプロンプト,メディアB,new_user@example.com,new_password
```

## トラブルシューティング

### インポートが失敗する

**原因1: ファイル形式が正しくない**
- 解決策: UTF-8で保存されているか確認
- 解決策: ヘッダー行が正しいか確認

**原因2: 必須フィールドが空**
- 解決策: サービス名とログインURLが入力されているか確認

**原因3: ファイルサイズが大きすぎる**
- 解決策: ファイルを分割してインポート

### 文字化けが発生する

- 解決策: ファイルを UTF-8 で保存し直す
- 解決策: Excel で開く場合は、「データ」→「テキストから」で UTF-8 を指定

### メディアが見つからない

- 原因: 指定したメディア名が存在しない
- 解決策: メディア名が正しいか確認、または先にメディアを作成

## 実装詳細

### コンポーネント

- **ファイル**: `apps/dashboard/src/components/agent/csv-import-client.tsx`
- **機能**: CSV ファイルのアップロード、パース、インポート処理

### アクション

- **ファイル**: `apps/dashboard/src/actions/asp-actions.ts`
- **関数**:
  - `bulkImportAspsFromCsv()`: CSV データの一括インポート
  - `exportAspsAsCsv()`: ASP データの CSV エクスポート

### データ型

```typescript
interface CsvImportRow {
  name: string;              // サービス名（必須）
  login_url: string;         // ログインURL（必須）
  category?: string;         // カテゴリ（オプション）
  prompt?: string;           // プロンプト（オプション）
  media_name?: string;       // メディア名（オプション）
  username?: string;         // ユーザー名（オプション）
  password?: string;         // パスワード（オプション）
}

interface CsvImportResult {
  success: number;           // 成功件数
  failed: number;            // 失敗件数
  errors: string[];          // エラーメッセージ
}
```

## セキュリティ上の注意

1. **パスワードの管理**:
   - CSV ファイルにパスワードを含める場合は、ファイルの取り扱いに注意
   - 不要になったら速やかに削除

2. **ファイルの共有**:
   - 認証情報を含む CSV ファイルは、セキュアな方法で共有
   - メールでの添付は避け、暗号化されたストレージを使用

3. **バックアップ**:
   - エクスポートした CSV ファイルは、安全な場所に保管
   - 定期的にバックアップを取得

## リファレンスファイル

主要なASPのリストが含まれる参考ファイルが用意されています：

- **ファイル**: `docs/04_development/reference/affiliate-services.csv`
- **内容**: 国内主要ASPのサービス名とURL
- **用途**: CSVインポート時のテンプレートとして使用可能

## ベストプラクティス

1. **小規模から開始**: 最初は少数のレコードでテスト
2. **バックアップ**: インポート前に既存データをエクスポート
3. **段階的な更新**: 大量のデータは複数回に分けてインポート
4. **検証**: インポート後にデータを確認
5. **ドキュメント化**: 独自のフィールドやルールを記録

## 関連ドキュメント

- [スクレイパー](./scrapers.md): ASPデータの自動収集について
- [Agent Management](../../01_requirements/detailed-specs/automation-management-page.md): Agent Management ページの仕様
