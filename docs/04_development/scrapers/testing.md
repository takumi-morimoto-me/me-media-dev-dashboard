# ASPスクレイパー テストチェックリスト

このドキュメントは、ASPスクレイパーの実装完了後に実施すべきテスト項目をまとめたチェックリストです。

## テスト実施時の前提条件

- [ ] `.env.local` に該当ASPの認証情報が設定されている
- [ ] Supabase接続情報が正しく設定されている
- [ ] テスト用のメディアID、勘定科目ID、ASP IDが準備されている
- [ ] Playwrightがインストールされている (`pnpm install` 実行済み)

## 1. データ取得機能テスト

### 1.1 日次スクレイパー

- [ ] **2025年1月からすべての日次データを取得できるか**
  - テスト方法: `startYearMonth: '202501'` を設定して実行
  - 確認内容: 2025年1月1日から現在日までのすべてのデータが取得されているか

- [ ] **取得データの形式が正しいか**
  - 各レコードに `date` (日付) が含まれているか
  - 各レコードに `amount` (金額) が数値として含まれているか
  - 日付形式が `YYYY-MM-DD` になっているか

- [ ] **データの整合性チェック**
  - 取得したデータに欠損日がないか
  - 金額がすべて0または負の値でないか (ASPによっては0の日もある)
  - 日付の重複がないか

### 1.2 月次スクレイパー

- [ ] **2025年1月からすべての月次データを取得できるか**
  - テスト方法: `startYearMonth: '202501'` を設定して実行
  - 確認内容: 2025年1月から現在月までのすべてのデータが取得されているか

- [ ] **月次データの取得日が該当月の月末になっているか**
  - 例: 2025年1月のデータは `2025-01-31` で保存されているか
  - 例: 2025年2月のデータは `2025-02-28` (うるう年の場合は `2025-02-29`) で保存されているか
  - 確認クエリ:
    ```sql
    SELECT date, amount, asp_id
    FROM actuals
    WHERE asp_id = 'YOUR_ASP_ID'
    ORDER BY date DESC;
    ```

- [ ] **取得データの形式が正しいか**
  - 各レコードに `date` (月末日付) が含まれているか
  - 各レコードに `amount` (月次合計金額) が数値として含まれているか

## 2. データ更新・上書き機能テスト

### 2.1 日次データの上書き

- [ ] **同じ日付のデータを再度取得した際、上書きされるか**
  - テスト方法:
    1. 初回データ取得実行
    2. 同じ期間のデータを再度取得
    3. データベースで重複がないか確認
  - 確認クエリ:
    ```sql
    SELECT date, COUNT(*) as count
    FROM daily_actuals
    WHERE asp_id = 'YOUR_ASP_ID'
    GROUP BY date
    HAVING COUNT(*) > 1;
    ```
  - 期待結果: 結果が0件であること (重複なし)

### 2.2 月次データの上書き

- [ ] **同じ月のデータを再度取得した際、上書きされるか**
  - テスト方法:
    1. 初回データ取得実行
    2. 同じ期間のデータを再度取得
    3. データベースで重複がないか確認
  - 確認クエリ:
    ```sql
    SELECT date, COUNT(*) as count
    FROM actuals
    WHERE asp_id = 'YOUR_ASP_ID'
    GROUP BY date
    HAVING COUNT(*) > 1;
    ```
  - 期待結果: 結果が0件であること (重複なし)

## 3. データ分離・合算チェック

- [ ] **日次データと月次データが合算されていないか**
  - 確認方法: `get_asp_monthly_data` 関数を実行
  - 確認クエリ:
    ```sql
    SELECT * FROM get_asp_monthly_data('YOUR_MEDIA_ID', 2025);
    ```
  - 確認内容:
    - 月次データが2倍になっていないか
    - 日次データの合計と月次データの値が別々に管理されているか
  - 参考: Migration 016 で修正済み（`actuals` テーブルのみ使用）

- [ ] **日次データと月次データが適切に分離されているか**
  - 確認内容:
    - `daily_actuals` テーブル: 日次データのみが保存されているか
    - `actuals` テーブル: 月次データのみが保存されているか (月末日付)

## 4. データベース反映チェック

### 4.1 日次データ (daily_actuals テーブル)

- [ ] **データが `daily_actuals` テーブルに正しく保存されているか**
  - 確認クエリ:
    ```sql
    SELECT date, amount, asp_id, media_id, account_item_id
    FROM daily_actuals
    WHERE asp_id = 'YOUR_ASP_ID'
      AND date >= '2025-01-01'
    ORDER BY date DESC
    LIMIT 10;
    ```
  - 確認内容:
    - `asp_id`, `media_id`, `account_item_id` が正しく設定されているか
    - `date` が日次単位で保存されているか
    - `amount` が正しい金額で保存されているか

### 4.2 月次データ (actuals テーブル)

- [ ] **データが `actuals` テーブルに正しく保存されているか**
  - 確認クエリ:
    ```sql
    SELECT date, amount, asp_id, media_id, account_item_id
    FROM actuals
    WHERE asp_id = 'YOUR_ASP_ID'
      AND date >= '2025-01-31'
    ORDER BY date DESC
    LIMIT 10;
    ```
  - 確認内容:
    - `asp_id`, `media_id`, `account_item_id` が正しく設定されているか
    - `date` が月末日付で保存されているか
    - `amount` が月次合計金額で保存されているか

## 5. 週次集計機能チェック

- [ ] **日次データから週次の合算が可能か**
  - 確認クエリ:
    ```sql
    SELECT
      DATE_TRUNC('week', date) AS week_start,
      SUM(amount) AS weekly_total
    FROM daily_actuals
    WHERE asp_id = 'YOUR_ASP_ID'
      AND date >= '2025-01-01'
    GROUP BY DATE_TRUNC('week', date)
    ORDER BY week_start DESC;
    ```
  - 確認内容:
    - 週次単位での集計が正しく行われているか
    - 週の開始日が統一されているか (通常は月曜日始まり)

- [ ] **週次集計関数が実装されているか**
  - 確認内容:
    - `get_asp_weekly_data` 関数が存在するか
    - 該当関数が `daily_actuals` テーブルを使用しているか
    - 出力形式が期待通りか

## 6. エラーハンドリングテスト

- [ ] **ログイン失敗時のエラーハンドリング**
  - テスト方法: 間違った認証情報でスクレイパーを実行
  - 期待結果: 適切なエラーメッセージが表示され、処理が停止すること

- [ ] **ネットワークエラー時のエラーハンドリング**
  - テスト方法: インターネット接続を切断してスクレイパーを実行
  - 期待結果: タイムアウトエラーが表示され、適切に処理が終了すること

- [ ] **データが存在しない期間の処理**
  - テスト方法: ASPでデータが存在しない期間を指定して実行
  - 期待結果: エラーが発生せず、0件のデータとして処理されること

- [ ] **データベース接続エラー時のエラーハンドリング**
  - テスト方法: Supabase接続情報を間違えて実行
  - 期待結果: データベース接続エラーが表示され、処理が停止すること

## 7. パフォーマンステスト

- [ ] **大量データ取得時のメモリ使用量**
  - テスト方法: 1年分以上のデータを取得
  - 確認内容: メモリエラーが発生しないか、処理時間が許容範囲内か

- [ ] **並列実行時の動作確認**
  - テスト方法: 複数のASPスクレイパーを同時に実行
  - 確認内容: 各スクレイパーが独立して正常に動作するか

## 8. ログ・デバッグ機能テスト

- [ ] **実行ログが適切に出力されているか**
  - 確認内容:
    - ログイン成功/失敗メッセージ
    - データ取得開始/完了メッセージ
    - 取得件数の表示
    - エラー発生時の詳細メッセージ

- [ ] **スクリーンショット機能が動作するか (ヘッドレスモード無効時)**
  - 確認内容: エラー発生時にスクリーンショットが保存されているか
  - 保存先: `/screenshots` ディレクトリ

## 9. 本番環境テスト

- [ ] **ヘッドレスモードでの動作確認**
  - テスト方法: `headless: true` で実行
  - 確認内容: ヘッドフルモードと同じ結果が得られるか

- [ ] **Cron/スケジューラーでの実行テスト**
  - テスト方法: cron や GitHub Actions で自動実行
  - 確認内容: 環境変数が正しく読み込まれ、自動実行されるか

## 10. データ整合性の最終確認

- [ ] **ASP管理画面の値とデータベースの値が一致するか**
  - 確認方法: ASP管理画面で表示される値と、データベースに保存された値を手動で比較
  - 確認内容:
    - 日次データの金額が一致するか
    - 月次データの合計金額が一致するか

- [ ] **複数期間の連続データ取得テスト**
  - テスト方法: 3ヶ月分のデータを取得し、各月のデータが連続しているか確認
  - 確認内容: データの欠損がないか

## テスト完了後のチェックリスト

- [ ] すべてのテスト項目が完了したか
- [ ] 発見された問題がすべて修正されたか
- [ ] ドキュメントが最新の実装に更新されているか
- [ ] 本番環境での実行準備が整っているか

## テスト実行例

### 日次スクレイパーのテスト

```bash
# ヘッドフルモードで実行 (デバッグ用)
pnpm tsx apps/dashboard/src/scripts/asp/daily/a8net/index.ts

# ヘッドレスモードで実行 (本番用)
HEADLESS=true pnpm tsx apps/dashboard/src/scripts/asp/daily/a8net/index.ts
```

### 月次スクレイパーのテスト

```bash
# 全期間データ取得
pnpm tsx apps/dashboard/src/scripts/asp/monthly/a8net/index.ts
```

### データベース確認

```bash
# Supabaseダッシュボードでクエリ実行
# または
pnpm tsx apps/dashboard/src/scripts/check-asp-data.ts
```

## 注意事項

- テスト実行前に、必ずバックアップを取得してください
- テスト用のメディアIDを使用し、本番データに影響を与えないようにしてください
- ASPの利用規約を遵守し、過度なリクエストを避けてください
- 認証情報は `.env.local` に保存し、GitHubにコミットしないでください

## 関連ドキュメント

- [ASPスクレイパー実装ガイド](./guide.md)
- [ASPスクレイパー概要](./overview.md)
- [ASP実装ステータス](./status.md)
