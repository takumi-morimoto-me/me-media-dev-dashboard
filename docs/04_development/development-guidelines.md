# 開発ガイドライン

本文書は、me-media-dev-dashboardプロジェクトにおける開発プロセスの一貫性と品質を担保するためのルールを定義します。

**最終更新**: 2025-11-04

## 1. 基本方針

### 1.1. データベース中心のアーキテクチャ

-   データの集計や複雑なビジネスロジックなど、パフォーマンスとデータ整合性が重要となる処理は、原則として**Supabase側（PostgreSQLのFunction, Viewなど）で実装**する。
-   これにより、フロントエンドは主にデータの表示とユーザー入力の受け付けに専念し、アプリケーション全体の役割分担を明確にする。フロントエンドは、Supabaseが提供するAPIを呼び出すことに注力する。

### 1.2. セキュリティ実装のフェーズ分け

セキュリティ機能の実装は、開発の生産性を考慮し、以下の段階で行う。

-   **初期開発フェーズ**:
    -   迅速な機能開発を優先するため、**認証およびアクセス制御（RLS）は実装しない**。
    -   開発中は、認証なしで全ての機能・データにアクセス可能とする。
-   **最終実装フェーズ**:
    -   本番リリース前に、**Supabase Authentication**を用いたユーザー認証と、**Supabase RLS**を用いた厳格なアクセス制御を必ず実装する。

---

## 2. コーディング規約・ルール

### 2.1. SQLのバージョン管理

-   **SQL Editorの使用**: Supabaseで作成するカスタム関数（Function）、ビュー（View）、トリガー（Trigger）などのデータベースオブジェクトは、**Supabase StudioのSQL Editorを使用して作成**する。
-   **バージョン管理**:
    -   SQL Editorで作成・変更したSQLコードは、変更履歴を追跡できるよう、必ず**バージョン管理システム（Git）で管理**する。
    -   マイグレーションファイルとしてリポジトリにコミットし、誰がいつどのような変更を加えたかを明確にする。

### 2.2. フロントエンド

-   **コンポーネント設計**:
    -   UIの部品は `shadcn/ui` をベースに構築し、可能な限り既存のコンポーネントを再利用する。
    -   ビジネスロジックを含むコンポーネントと、表示のみに責務を持つUIコンポーネントを意識的に分離する。
-   **状態管理**:
    -   シンプルな状態管理にはReact標準のフック（`useState`, `useContext`）を用いる。
    -   複数のコンポーネント間で共有される複雑な状態については、別途ライブラリ（Zustand, Jotaiなど）の導入を検討する。

### 2.3. コミットメッセージ

-   コミットメッセージは、変更内容が簡潔に理解できるよう、Conventional Commitsの規約に準拠することを推奨する。
    -   例: `feat: add CSV import functionality` / `fix: correct calculation logic in summary`

### 2.4. 仮データ管理 (Mock Data Management)

-   **目的**: バックエンド機能が未実装の段階でもフロントエンド開発を進められるよう、仮のデータ（モックデータ）を活用する。
-   **配置場所**: モックデータはすべて `src/lib/mock-data/` ディレクトリ内に配置し、一元管理する。
-   **削除**: 関連機能が本番のバックエンドと連携された後、`rm -rf src/lib/mock-data` コマンドでディレクトリごと容易に削除できるようにする。

### 2.5. ASPスクレイパー実装ルール

#### データ保存の必須ルール

**⚠️ 最重要: 日次・月次データの分離と日付ルール**

1. **日次データ**:
   - テーブル: `daily_actuals`
   - 日付: 実際の日付（例: `2025-01-15`）

2. **月次データ**:
   - テーブル: `actuals`
   - 日付: **必ず月末日付**（例: `2025-01-31`）
   - ❌ 月初日付（`2025-01-01`）は絶対に使用しない

3. **データ分離**:
   - 日次と月次を**絶対に合算しない**
   - 各テーブルに独立して保存

詳細は [データ仕様書](../01_requirements/detailed-specs/data-specification.md) を参照。

#### 実装ガイド

新しいスクレイパーを実装する際は：
1. [スクレイパー実装ガイド](./scrapers/guide.md) に従う
2. [テストチェックリスト](./scrapers/testing.md) で検証
3. テストスクリプト `test-scraper-data.ts` で自動テスト

#### テスト必須項目

全てのスクレイパーは以下のテストに合格する必要があります：
- ✅ 月次データが月末日付で保存される
- ✅ データの重複がない（UPSERT機能）
- ✅ 日次・月次が合算されていない
- ✅ 週次集計が可能（日次データから）