# アーキテクチャ決定記録

## 決定事項

**日付**: 2025-12-03

**決定内容**: スクレイパーベース方式を採用

**理由**:
1. AI/プロンプト方式は実運用で安定性に課題があった
2. 各ASPのサイト構造に合わせた専用スクレイパーの方が確実
3. スクレイパーの自動修復（healer）機能でメンテナンスコストを軽減

---

## 現在のアーキテクチャ（2025-12-03〜）

### 構成

```
apps/
├── dashboard/     (Next.js) - UI・ASP管理
└── mcp-agent/     (Python) - スクレイパー実行
packages/
└── db/            (Supabase) - 共有データベース
```

### 技術スタック

- **Python + Playwright** - ブラウザ自動操作
- **ASP専用スクレイパー** - `scrapers/*/scraper.py`
- **BaseScraper** - 共通基盤クラス
- **ScraperHealer** - AI（Gemini）によるスクレイパー自動修復
- **Cloud Run** - 定期実行環境

### 設計思想

> 「各ASPに対して専用のPythonスクレイパーを実装し、定期的にシステムで自動実行する。AIは主にスクレイパーの自動修復（セレクタ変更への対応等）に活用する」

### メリット

- ✅ 安定したデータ取得が可能
- ✅ エラー発生時の原因特定が容易
- ✅ スクレイパーの動作が予測可能
- ✅ AIによる自動修復で保守コストを軽減

### デメリット

- ⚠️ 新規ASP追加時にスクレイパー実装が必要
- ⚠️ 大きなサイト変更時はコード修正が必要

---

## 過去の検討履歴

### 当初の設計（〜2025-11）

**構成**:
- Python + Playwright + Gemini
- 自然言語シナリオ（プロンプト）をDBに保存
- AIがプロンプトを解釈してブラウザ操作

**設計思想**:
> 「非エンジニアが自然言語のシナリオ（プロンプト）を編集するだけで、AIエージェントが自律的にブラウザを操作してデータを取得する」

**課題**:
- AIの解釈が不安定でエラーが頻発
- プロンプトの調整が難しい
- デバッグが困難

### 移行の経緯

1. 当初はAIエージェント方式で実装を進めた
2. 実運用で安定性に課題があることが判明
3. スクレイパーベース方式への移行を決定
4. プロンプト関連のコード・UIを削除（2025-12-03）

---

## 削除されたもの（2025-12-03）

- `asps.prompt` カラム - DBから削除予定
- `scenarios/*.yaml` - シナリオファイル
- `core/orchestrator.py` - シナリオ実行エンジン
- `core/scenario_loader.py` - シナリオ読み込み
- `core/scraper_generator.py` - スクレイパー自動生成
- ダッシュボードのプロンプト関連UI

---

最終更新: 2025-12-03
