# アーキテクチャ決定記録

## 当初の設計 vs 現状のギャップ

### 当初の設計（削除されたmcp-agent）

**構成**:
```
apps/
├── dashboard/     (Next.js) - UI・シナリオ管理
└── mcp-agent/     (Python) - AIエージェント
packages/
└── db/            (Supabase) - 共有データベース
```

**技術スタック**:
- Python + Playwright
- Vertex AI (Gemini) - 自然言語シナリオ解釈
- Google Cloud Run - サーバーレス実行
- Turbo - モノレポ管理

**設計思想**:
> 「非エンジニアが自然言語のシナリオ（プロンプト）を編集するだけで、AIエージェントが自律的にブラウザを操作してデータを取得する」

**メリット**:
- ✅ ASPの仕様変更時、コード修正不要（プロンプト修正のみ）
- ✅ 非エンジニアでも保守可能
- ✅ 新規ASP追加が容易（シナリオを書くだけ）
- ✅ AIが状況判断して柔軟に対応

**なぜTurboを入れたか**:
- Next.js (TypeScript) と Python を同一リポジトリで管理するため

---

### 現状（2025-11-07）

**構成**:
```
apps/
└── dashboard/     (Next.js) のみ
packages/
└── db/            (Supabase)
```

**実装内容**:
- TypeScript/TSX + Playwright
- **26件のASPスクレイパーを手動実装**
- 各ASPごとに個別のスクレイパークラス（200-900行）
- AI/LLMは不使用

**問題点**:
- ❌ Turboが不要（アプリが1つだけ）
- ❌ 保守性が低い（ASP変更のたびにコード修正）
- ❌ 新規ASP追加のコストが高い
- ❌ 当初の設計思想と完全に乖離

---

## 今後の方向性（2つの選択肢）

### 選択肢A: 当初の設計に戻す（推奨）

**実装内容**:
1. `apps/mcp-agent` をPythonで再実装
2. Vertex AI (Gemini) を使った自律AIエージェント
3. 各ASPの「シナリオ（プロンプト）」をデータベースに保存
4. Cloud Runで定期実行

**メリット**:
- ✅ 保守性が高い（プロンプト修正のみ）
- ✅ 新規ASP追加が容易
- ✅ 当初の設計意図に沿っている
- ✅ Turboの存在意義がある

**デメリット**:
- ⏱ Python環境のセットアップが必要
- ⏱ Vertex AIの学習コスト
- 💰 AI APIコスト（ただし安い）

**実装手順**:
1. `apps/mcp-agent` ディレクトリを復活
2. Python環境セットアップ（pyproject.toml, requirements.txt）
3. Playwrightセットアップ
4. Gemini連携実装
5. 汎用的なエージェントループ実装
6. 既存の26件のスクレイパーをプロンプトに変換

---

### 選択肢B: 現状を維持（非推奨）

**実装内容**:
- 現在の26件のTypeScriptスクレイパーを維持
- Turboを削除してシンプルなNext.jsプロジェクトに変更

**メリット**:
- ✅ 追加実装不要（すぐに使える）
- ✅ TypeScriptのみで完結

**デメリット**:
- ❌ 保守コストが高い
- ❌ 新規ASP追加が大変
- ❌ 当初の設計意図を放棄
- ❌ Turboが無駄になっている

**実装手順**:
1. Turbo削除
2. `pnpm-workspace.yaml` 削除
3. `apps/dashboard` を root に移動
4. シンプルなNext.jsプロジェクトに整理

---

## 推奨：選択肢A（AIエージェント方式）

### 理由

1. **当初の設計思想が正しい**
   - 26件のスクレイパーを見ればわかる通り、手動実装は膨大な作業量
   - ASP仕様変更のたびにコード修正は現実的でない

2. **保守性・拡張性が圧倒的に高い**
   - プロンプト修正だけで対応可能
   - 非エンジニアでも保守できる

3. **実装コストは低い**
   - Geminiは安価（1リクエスト数円）
   - 既存のスクレイパーコードを参考にプロンプト作成可能

4. **技術的に面白い**
   - AIエージェントの実践的な活用事例
   - モダンな技術スタック

---

## 次のステップ（選択肢Aを選んだ場合）

### Phase 1: Python環境セットアップ（1-2日）
- [ ] `apps/mcp-agent` ディレクトリ作成
- [ ] Python環境構築（pyproject.toml, requirements.txt）
- [ ] Playwright for Pythonセットアップ
- [ ] Supabase Python SDKセットアップ

### Phase 2: 基本的なエージェント実装（3-5日）
- [ ] Vertex AI (Gemini) SDK連携
- [ ] 汎用的なブラウザ操作エンジン
- [ ] シナリオ解釈ループ
- [ ] データベースへの保存処理

### Phase 3: シナリオ作成（1週間）
- [ ] A8.net のプロンプト作成・テスト
- [ ] もしもアフィリエイトのプロンプト作成・テスト
- [ ] Link-AG のプロンプト作成・テスト
- [ ] 他23件のASPプロンプト作成

### Phase 4: 本番稼働（1-2日）
- [ ] Google Cloud Run デプロイ
- [ ] Cloud Scheduler 設定
- [ ] Secret Manager 設定
- [ ] 監視・ログ設定

---

## 決定事項

**日付**: 2025-11-07

**決定内容**: （未定）

**理由**: ユーザーと相談して決定

---

最終更新: 2025-11-07
