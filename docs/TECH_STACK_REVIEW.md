# 技術選定レビュー - ASP自動取得システム

**日付**: 2025-11-07
**目的**: ASP自動データ取得における技術選定の妥当性を確認

---

## 📋 現在の技術スタック

### 1. ブラウザ自動化: Playwright (Python)

**選定理由**:
- ✅ モダンでメンテナンスされている
- ✅ 自動待機機能が優秀（安定性が高い）
- ✅ Python SDKが充実
- ✅ TypeScript版で既に使用中（知見がある）

**他の選択肢**:
| ツール | メリット | デメリット |
|--------|---------|-----------|
| **Selenium** | ・歴史が長い<br>・情報が多い | ・遅い<br>・不安定<br>・古い設計 |
| **Puppeteer** | ・軽量<br>・Node.js | ・Pythonでは使えない<br>・Chrome限定 |
| **BeautifulSoup + requests** | ・軽量<br>・高速 | ・JavaScriptサイトに弱い<br>・ASPはほぼJS必須 |

**結論**: ✅ **Playwright が最適**

---

### 2. AI/LLM: Gemini API

**選定理由**:
- ✅ 安い（GPT-4より圧倒的に安い）
- ✅ 速い（Flash版は高速）
- ✅ APIキーだけで使える（GCP不要）
- ✅ 無料枠がある

**他の選択肢**:
| LLM | 料金 | メリット | デメリット |
|-----|------|---------|-----------|
| **Gemini 1.5 Flash** | $0.075/1M tokens | ・速い<br>・安い<br>・無料枠あり | ・精度はGPT-4より劣る？ |
| **GPT-4 Turbo** | $10/1M tokens | ・高精度 | ・高い（133倍）<br>・OpenAI APIキー必要 |
| **Claude 3.5 Sonnet** | $3/1M tokens | ・高精度<br>・長文対応 | ・中程度の価格<br>・Anthropic APIキー必要 |
| **ローカルLLM（Llama等）** | 無料 | ・完全無料 | ・セットアップ大変<br>・精度低い<br>・GPU必要 |

**コスト試算** (1日26ASP、各10ステップ、2000トークン/回):
- Gemini Flash: **約$0.04/日** = 月$1.2
- GPT-4 Turbo: **約$5.2/日** = 月$156
- Claude Sonnet: **約$1.56/日** = 月$46.8

**結論**: ✅ **Gemini Flash が最適**（コスパ最強）

---

### 3. データベース: Supabase (PostgreSQL)

**選定理由**:
- ✅ 既に使用中
- ✅ Python SDKが充実
- ✅ RESTful API
- ✅ 無料枠が十分

**他の選択肢**:
- MySQL/MongoDB: 特に理由がなければSupabaseで十分
- Firebase: リアルタイム不要なので過剰

**結論**: ✅ **Supabase で問題なし**

---

## ⚠️ 潜在的な課題

### 課題1: Geminiの精度は十分か？

**懸念点**:
- HTMLから正しいセレクタを抽出できるか？
- 複雑なページでも対応できるか？

**対策**:
1. **プロンプトエンジニアリング**で精度向上
2. **Few-shot examples** を与える
3. 失敗したら **Claude/GPT-4に切り替え可能** な設計にする

**設計方針**:
```python
class LLMClient:
    """抽象クラス"""
    def interpret_step(self, step, context):
        pass

class GeminiClient(LLMClient):
    """Gemini実装"""
    pass

class ClaudeClient(LLMClient):
    """Claude実装（フォールバック用）"""
    pass
```

---

### 課題2: レート制限

**Gemini Flash 無料枠**:
- 15 RPM (1分あたり15リクエスト)
- 1日1500リクエスト
- 150万トークン/日

**必要量** (26ASP、各10ステップ):
- 260リクエスト/日
- 520,000トークン/日

**結論**: ✅ **無料枠で十分**（余裕あり）

---

### 課題3: Playwrightの安定性

**懸念点**:
- ASPサイトが頻繁に変わる
- CAPTCHAが出る可能性

**対策**:
1. **User-Agent偽装**
2. **ランダムな待機時間**
3. **リトライ機構**
4. **CAPTCHA検知 → 手動介入通知**

---

## 🤔 代替案の検討

### 案1: TypeScript版をそのまま使う

**メリット**:
- ✅ 既に実装済み
- ✅ すぐ使える

**デメリット**:
- ❌ 保守コストが高い（26ASP × 200-900行）
- ❌ ASP変更のたびにコード修正
- ❌ 新規ASP追加が大変

**結論**: ❌ 長期的には不採用

---

### 案2: Gemini + Playwright（現在の案）

**メリット**:
- ✅ 保守コストが低い
- ✅ プロンプト修正のみで対応
- ✅ 新規ASP追加が容易
- ✅ コストが安い

**デメリット**:
- ❌ Geminiの精度が未検証
- ❌ 実装・テストが必要

**結論**: ✅ **採用**（要PoC）

---

### 案3: Claude + Playwright

**メリット**:
- ✅ 高精度（Claude 3.5 Sonnetは優秀）
- ✅ 長文対応

**デメリット**:
- ❌ Geminiの40倍高い（月$46 vs $1.2）
- ❌ APIキー管理が増える

**結論**: 🔺 **フォールバック候補**（Geminiで精度不足なら）

---

### 案4: GPT-4 + Playwright

**メリット**:
- ✅ 最高精度

**デメリット**:
- ❌ Geminiの130倍高い（月$156 vs $1.2）
- ❌ オーバースペック

**結論**: ❌ 不採用（高すぎる）

---

## 🎯 最終推奨構成

### Phase 1: PoC（概念実証）

```
技術スタック:
- Python 3.11
- Playwright
- Gemini 1.5 Flash
- Supabase
```

**目標**:
1. A8.net で動作確認
2. もしもアフィリエイトで動作確認
3. Link-AG で動作確認

**判断基準**:
- 成功率 > 80% → 本格導入
- 成功率 < 80% → Claude/GPT-4を検討

---

### Phase 2: 本格導入

**戦略**:
1. Gemini Flashをメインに使用
2. 失敗が多いASPだけClaudeを使用（ハイブリッド）

**設計**:
```python
# aspsテーブルに "llm_provider" カラムを追加
{
  "name": "A8.net",
  "llm_provider": "gemini",  # デフォルト
  "prompt": "..."
}

{
  "name": "ComplexASP",
  "llm_provider": "claude",  # 難しいASPだけ
  "prompt": "..."
}
```

---

## 📊 コスト比較（月次）

| 構成 | LLMコスト | その他 | 合計 |
|------|----------|--------|------|
| **Gemini Flash（推奨）** | $1.2 | $0 | **$1.2/月** |
| Gemini Flash + Claude（ハイブリッド） | $5-10 | $0 | $5-10/月 |
| Claude Sonnet | $46.8 | $0 | $46.8/月 |
| GPT-4 Turbo | $156 | $0 | $156/月 |
| TypeScript版（AI不使用） | $0 | 人件費高 | ? |

---

## ✅ 結論

### 現在の技術選定は妥当か？

**Yes！** ただし、以下の条件付き：

1. ✅ **Playwright**: 最適な選択
2. ✅ **Gemini Flash**: コスパ最強、まずこれで試す
3. ✅ **Supabase**: 問題なし
4. 🔺 **フォールバック**: Claude/GPT-4も使えるように設計

---

## 🚀 次のアクション

### 1. PoC実施（1週間）

```bash
# 3件のASPでテスト
1. A8.net
2. もしもアフィリエイト
3. Link-AG
```

**成功基準**:
- ログイン成功率 > 90%
- データ抽出成功率 > 80%
- レスポンス時間 < 2分/ASP

### 2. 結果に応じて判断

**成功した場合** → 残り23ASPに展開

**精度が低い場合** → 以下を試す：
1. プロンプト改善
2. Few-shot examples追加
3. Claude/GPT-4検討

---

## 📝 技術選定まとめ

| 項目 | 選択 | 代替案 | 判定 |
|------|------|--------|------|
| ブラウザ自動化 | **Playwright** | Selenium, Puppeteer | ✅ 最適 |
| AI/LLM | **Gemini Flash** | Claude, GPT-4 | ✅ 最適（要PoC） |
| データベース | **Supabase** | MySQL, Firebase | ✅ 問題なし |
| 実行環境 | **ローカル** | Cloud Run | ✅ シンプル |

---

## 🤔 懸念点への対策

1. **Gemini精度不足** → Claude/GPT-4フォールバック
2. **レート制限** → 無料枠で十分（余裕あり）
3. **CAPTCHA** → 検知して手動介入通知
4. **ASP仕様変更** → プロンプト修正のみ（コード不要）

---

**結論: 技術選定は妥当。まずはPoCで検証すべし。**

---

最終更新: 2025-11-07
