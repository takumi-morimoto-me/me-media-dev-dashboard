# Webridge（ビギナーズ・OJ）シナリオ定義
name: webridge
display_name: "Webridge（ビギナーズ・OJ）"
asp_name_in_db: "Webridge（ビギナーズ・OJ）"
login_url: https://webridge.net/ja_jp/top/publisher/login

credentials:
  username_key: WEBRIDGE_USERNAME
  password_key: WEBRIDGE_PASSWORD

# 月次データ取得シナリオ
monthly:
  description: "月別レポートから承認報酬（USD→JPY換算）を取得"
  currency: USD
  actions:
    - action: navigate
      value: https://webridge.net/ja_jp/top/publisher/login
    - action: wait
      milliseconds: 2000
    # ログインフォーム入力
    - action: click
      selector: "input[name='loginUser']"
    - action: fill
      selector: "input[name='loginUser']"
      value: "{SECRET:WEBRIDGE_USERNAME}"
    - action: wait
      milliseconds: 500
    - action: click
      selector: "input[name='loginPassword']"
    - action: fill
      selector: "input[name='loginPassword']"
      value: "{SECRET:WEBRIDGE_PASSWORD}"
    - action: wait
      milliseconds: 500
    - action: press
      selector: "input[name='loginPassword']"
      key: "Enter"
    - action: wait
      milliseconds: 3000
    # スクリーンショットを撮る（ログイン後）
    - action: screenshot
      path: "/tmp/webridge_after_login.png"
    # 詳細レポートをクリックして展開
    - action: click
      selector: "text=詳細レポート"
    - action: wait
      milliseconds: 1000
    # 月別をクリック
    - action: click
      selector: "a:has-text('月別')"
    - action: wait
      milliseconds: 3000
    # スクリーンショットを撮る（月別ページ）
    - action: screenshot
      path: "/tmp/webridge_monthly.png"
    # 条件を追加して検索をクリック
    - action: click
      selector: "text=条件を追加して検索"
    - action: wait
      milliseconds: 1000
    # 期間指定（2025年1月から）
    - action: select
      selector: "select[name='search_start_year']"
      value: "2025"
    - action: select
      selector: "select[name='search_start_month']"
      value: "1"
    # 検索実行
    - action: click
      selector: "button:has-text('検索実行')"
    - action: wait
      milliseconds: 3000
    # CSVダウンロード
    - action: download
      selector: "button:has-text('CSVダウンロード'), a:has-text('CSVダウンロード')"
      path: "/tmp/webridge_monthly.csv"
    # CSVからデータ抽出
    - action: extract_csv
      path: "/tmp/webridge_monthly.csv"
      target: actuals
      date_column: "年月"
      amount_column: "承認報酬"
      currency: USD

# 日次データ取得シナリオ
daily:
  description: "日別レポートから承認報酬（USD→JPY換算）を取得"
  currency: USD
  actions:
    - action: navigate
      value: https://webridge.net/ja_jp/top/publisher/login
    - action: wait
      milliseconds: 2000
    # ログインフォーム入力
    - action: click
      selector: "input[name='loginUser']"
    - action: fill
      selector: "input[name='loginUser']"
      value: "{SECRET:WEBRIDGE_USERNAME}"
    - action: wait
      milliseconds: 500
    - action: click
      selector: "input[name='loginPassword']"
    - action: fill
      selector: "input[name='loginPassword']"
      value: "{SECRET:WEBRIDGE_PASSWORD}"
    - action: wait
      milliseconds: 500
    - action: press
      selector: "input[name='loginPassword']"
      key: "Enter"
    - action: wait
      milliseconds: 3000
    # スクリーンショットを撮る（ログイン後）
    - action: screenshot
      path: "/tmp/webridge_after_login.png"
    # 詳細レポートをクリックして展開
    - action: click
      selector: "text=詳細レポート"
    - action: wait
      milliseconds: 1000
    # 日別をクリック
    - action: click
      selector: "a:has-text('日別')"
    - action: wait
      milliseconds: 3000
    # スクリーンショットを撮る（日別ページ）
    - action: screenshot
      path: "/tmp/webridge_daily.png"
    # 条件を追加して検索をクリック
    - action: click
      selector: "text=条件を追加して検索"
    - action: wait
      milliseconds: 1000
    # 今月を選択
    - action: click
      selector: "label:has-text('今月')"
    - action: wait
      milliseconds: 500
    # 検索実行
    - action: click
      selector: "button:has-text('検索実行')"
    - action: wait
      milliseconds: 3000
    # CSVダウンロード
    - action: download
      selector: "button:has-text('CSVダウンロード'), a:has-text('CSVダウンロード')"
      path: "/tmp/webridge_daily.csv"
    # CSVからデータ抽出
    - action: extract_csv
      path: "/tmp/webridge_daily.csv"
      target: daily_actuals
      date_column: "年月日"
      amount_column: "承認報酬"
      currency: USD

# リトライ設定
retry:
  max_attempts: 3
  delay_ms: 2000
  retry_on:
    - timeout
    - element_not_found

# 特記事項
notes:
  - "通貨はUSD、為替レートでJPYに換算が必要"
  - "reCAPTCHA v3による保護あり、headless=falseでの実行を推奨"
  - "サイドバーの「詳細レポート」は展開式メニュー"
