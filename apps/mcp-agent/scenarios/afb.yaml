# afb (アフィリエイトB) シナリオ定義
name: afb
display_name: "afb（アフィリエイトB）"
asp_name_in_db: "afb（ビギナーズ・OJ）"
login_url: https://www.afi-b.com/

credentials:
  username_key: AFB_USERNAME
  password_key: AFB_PASSWORD

# 月次データ取得シナリオ
monthly:
  description: "月別レポートから発生報酬を取得"
  actions:
    - action: navigate
      value: https://www.afi-b.com/
    - action: wait
      milliseconds: 2000
    - action: fill
      selector: "input[type='text']"
      value: "{SECRET:AFB_USERNAME}"
    - action: fill
      selector: "input[type='password']"
      value: "{SECRET:AFB_PASSWORD}"
    - action: click
      selector: "input[type='submit'], button[type='submit']"
    - action: wait
      milliseconds: 5000
    - action: hover
      selector: "text=レポート"
    - action: wait
      milliseconds: 1000
    - action: click
      selector: "text=月別レポート"
    - action: wait
      milliseconds: 3000
    - action: click
      selector: "input[type='image'][alt*='表示'], input[type='submit'][value*='表示']"
    - action: wait
      milliseconds: 5000
    - action: extract
      selector: table
      target: actuals

# 日次データ取得シナリオ
daily:
  description: "日別レポートから発生報酬を取得"
  actions:
    # ログイン
    - action: navigate
      value: https://www.afi-b.com/
    - action: wait
      milliseconds: 2000
    - action: fill
      selector: "input[type='text']"
      value: "{SECRET:AFB_USERNAME}"
    - action: fill
      selector: "input[type='password']"
      value: "{SECRET:AFB_PASSWORD}"
    - action: click
      selector: "input[type='submit'], button[type='submit']"
    - action: wait
      milliseconds: 5000
    # ポップアップを閉じる
    - action: keyboard
      key: Escape
    - action: wait
      milliseconds: 1000
    # 直接日別レポートページに移動
    - action: navigate
      value: https://www.afi-b.com/pa/report/?r=daily
    - action: wait
      milliseconds: 3000
    # 日別タブをクリック（#tab_btn_topにスクロール）
    - action: click
      selector: "a[href*='#tab_btn_top'][title='日別レポート'], #tab_btn_top a:has-text('日別')"
    - action: wait
      milliseconds: 2000
    # レポート表示ボタンをクリック
    - action: click
      selector: "input[data-testid='daily-display-report'], input.send_report:visible"
    - action: wait
      milliseconds: 5000
    # スクリーンショットを撮る
    - action: screenshot
      path: "/tmp/afb_daily_before_extract.png"
    # スクロールしてメインテーブルを表示
    - action: scroll
      value: 500
    - action: wait
      milliseconds: 1000
    # データ抽出（マイレポートテーブル）
    - action: extract
      selector: "table"
      target: daily_actuals

# リトライ設定
retry:
  max_attempts: 3
  delay_ms: 2000
  retry_on:
    - timeout
    - element_not_found
